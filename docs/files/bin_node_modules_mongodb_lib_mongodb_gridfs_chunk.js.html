<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>bin/node_modules/mongodb/lib/mongodb/gridfs/chunk.js - Prometheus Framework</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Prometheus Framework"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Represents a 
                Replicaset Configuration.html">Represents a 
                Replicaset Configuration</a></li>
                                <li><a href="../classes/Represents a BatchWriteResult.html">Represents a BatchWriteResult</a></li>
                                <li><a href="../classes/Represents a Collection.html">Represents a Collection</a></li>
                                <li><a href="../classes/Represents a Cursor..html">Represents a Cursor.</a></li>
                                <li><a href="../classes/Represents a CursorStream..html">Represents a CursorStream.</a></li>
                                <li><a href="../classes/Represents a Db.html">Represents a Db</a></li>
                                <li><a href="../classes/Represents a GridFS File Stream..html">Represents a GridFS File Stream.</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/Represents a MongoClient.html">Represents a MongoClient</a></li>
                                <li><a href="../classes/Represents a Mongos connection with failover to backup proxies.html">Represents a Mongos connection with failover to backup proxies</a></li>
                                <li><a href="../classes/Represents a OrderedBulkOperation.html">Represents a OrderedBulkOperation</a></li>
                                <li><a href="../classes/Represents a Read Preference..html">Represents a Read Preference.</a></li>
                                <li><a href="../classes/Represents a Server connection..html">Represents a Server connection.</a></li>
                                <li><a href="../classes/Represents a UnorderedBulkOperation.html">Represents a UnorderedBulkOperation</a></li>
                                <li><a href="../classes/Represents the Admin methods of MongoDB..html">Represents the Admin methods of MongoDB.</a></li>
                                <li><a href="../classes/Represents the Grid..html">Represents the Grid.</a></li>
                                <li><a href="../classes/Represents the GridStore..html">Represents the GridStore.</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/association.html">association</a></li>
                                <li><a href="../modules/database-accessor.html">database-accessor</a></li>
                                <li><a href="../modules/field-type-manager.html">field-type-manager</a></li>
                                <li><a href="../modules/resource-type-manager.html">resource-type-manager</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: bin/node_modules/mongodb/lib/mongodb/gridfs/chunk.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        var Binary = require(&#x27;bson&#x27;).Binary,
                          ObjectID = require(&#x27;bson&#x27;).ObjectID;
                        
                        /**
                         * Class for representing a single chunk in GridFS.
                         *
                         * @class
                         *
                         * @param file {GridStore} The {@link GridStore} object holding this chunk.
                         * @param mongoObject {object} The mongo object representation of this chunk.
                         *
                         * @throws Error when the type of data field for {@link mongoObject} is not
                         *     supported. Currently supported types for data field are instances of
                         *     {@link String}, {@link Array}, {@link Binary} and {@link Binary}
                         *     from the bson module
                         *
                         * @see Chunk#buildMongoObject
                         */
                        var Chunk = exports.Chunk = function(file, mongoObject, writeConcern) {
                          if(!(this instanceof Chunk)) return new Chunk(file, mongoObject);
                        
                          this.file = file;
                          var self = this;
                          var mongoObjectFinal = mongoObject == null ? {} : mongoObject;
                          this.writeConcern = writeConcern || {w:1};
                          this.objectId = mongoObjectFinal._id == null ? new ObjectID() : mongoObjectFinal._id;
                          this.chunkNumber = mongoObjectFinal.n == null ? 0 : mongoObjectFinal.n;
                          this.data = new Binary();
                        
                          if(mongoObjectFinal.data == null) {
                          } else if(typeof mongoObjectFinal.data == &quot;string&quot;) {
                            var buffer = new Buffer(mongoObjectFinal.data.length);
                            buffer.write(mongoObjectFinal.data, &#x27;binary&#x27;, 0);
                            this.data = new Binary(buffer);
                          } else if(Array.isArray(mongoObjectFinal.data)) {
                            var buffer = new Buffer(mongoObjectFinal.data.length);
                            buffer.write(mongoObjectFinal.data.join(&#x27;&#x27;), &#x27;binary&#x27;, 0);
                            this.data = new Binary(buffer);
                          } else if(mongoObjectFinal.data instanceof Binary || mongoObjectFinal.data._bsontype === &#x27;Binary&#x27; || Object.prototype.toString.call(mongoObjectFinal.data) == &quot;[object Binary]&quot;) {
                            this.data = mongoObjectFinal.data;
                          } else if(Buffer.isBuffer(mongoObjectFinal.data)) {
                          } else {
                            throw Error(&quot;Illegal chunk format&quot;);
                          }
                          
                          // Update position
                          this.internalPosition = 0;
                        };
                        
                        /**
                         * Writes a data to this object and advance the read/write head.
                         *
                         * @param data {string} the data to write 
                         * @param callback {function(*, GridStore)} This will be called after executing
                         *     this method. The first parameter will contain null and the second one
                         *     will contain a reference to this object.
                         */
                        Chunk.prototype.write = function(data, callback) {
                          this.data.write(data, this.internalPosition);
                          this.internalPosition = this.data.length();
                          if(callback != null) return callback(null, this);
                          return this;
                        };
                        
                        /**
                         * Reads data and advances the read/write head.
                         *
                         * @param length {number} The length of data to read.
                         *
                         * @return {string} The data read if the given length will not exceed the end of
                         *     the chunk. Returns an empty String otherwise.
                         */
                        Chunk.prototype.read = function(length) {
                          // Default to full read if no index defined
                          length = length == null || length == 0 ? this.length() : length;
                        
                          if(this.length() - this.internalPosition + 1 &gt;= length) {
                            var data = this.data.read(this.internalPosition, length);
                            this.internalPosition = this.internalPosition + length;
                            return data;
                          } else {
                            return &#x27;&#x27;;
                          }
                        };
                        
                        Chunk.prototype.readSlice = function(length) {
                          if ((this.length() - this.internalPosition) &gt;= length) {
                            var data = null;
                            if (this.data.buffer != null) { //Pure BSON
                              data = this.data.buffer.slice(this.internalPosition, this.internalPosition + length);
                            } else { //Native BSON
                              data = new Buffer(length);
                              length = this.data.readInto(data, this.internalPosition);
                            }
                            this.internalPosition = this.internalPosition + length;
                            return data;
                          } else {
                            return null;
                          }
                        };
                        
                        /**
                         * Checks if the read/write head is at the end.
                         *
                         * @return {boolean} Whether the read/write head has reached the end of this
                         *     chunk.
                         */
                        Chunk.prototype.eof = function() {
                          return this.internalPosition == this.length() ? true : false;
                        };
                        
                        /**
                         * Reads one character from the data of this chunk and advances the read/write
                         * head.
                         *
                         * @return {string} a single character data read if the the read/write head is
                         *     not at the end of the chunk. Returns an empty String otherwise.
                         */
                        Chunk.prototype.getc = function() {
                          return this.read(1);
                        };
                        
                        /**
                         * Clears the contents of the data in this chunk and resets the read/write head
                         * to the initial position.
                         */
                        Chunk.prototype.rewind = function() {
                          this.internalPosition = 0;
                          this.data = new Binary();
                        };
                        
                        /**
                         * Saves this chunk to the database. Also overwrites existing entries having the
                         * same id as this chunk.
                         *
                         * @param callback {function(*, GridStore)} This will be called after executing
                         *     this method. The first parameter will contain null and the second one
                         *     will contain a reference to this object.
                         */
                        Chunk.prototype.save = function(options, callback) {
                          var self = this;
                          if(typeof options == &#x27;function&#x27;) {
                            callback = options;
                            options = {};
                          }
                        
                          self.file.chunkCollection(function(err, collection) {
                            if(err) return callback(err);
                        
                            // Merge the options
                            var writeOptions = {};
                            for(var name in options) writeOptions[name] = options[name];
                            for(var name in self.writeConcern) writeOptions[name] = self.writeConcern[name];    
                        
                            // collection.remove({&#x27;_id&#x27;:self.objectId}, self.writeConcern, function(err, result) {
                            collection.remove({&#x27;_id&#x27;:self.objectId}, writeOptions, function(err, result) {
                              if(err) return callback(err);
                        
                              if(self.data.length() &gt; 0) {
                                self.buildMongoObject(function(mongoObject) {
                                  var options = {forceServerObjectId:true};
                                  for(var name in self.writeConcern) {
                                    options[name] = self.writeConcern[name];
                                  }
                        
                                  collection.insert(mongoObject, writeOptions, function(err, collection) {
                                    callback(err, self);
                                  });
                                });
                              } else {
                                callback(null, self);
                              }
                            });
                          });
                        };
                        
                        /**
                         * Creates a mongoDB object representation of this chunk.
                         *
                         * @param callback {function(Object)} This will be called after executing this 
                         *     method. The object will be passed to the first parameter and will have
                         *     the structure:
                         *        
                         *        &lt;pre&gt;&lt;code&gt;
                         *        {
                         *          &#x27;_id&#x27; : , // {number} id for this chunk
                         *          &#x27;files_id&#x27; : , // {number} foreign key to the file collection
                         *          &#x27;n&#x27; : , // {number} chunk number
                         *          &#x27;data&#x27; : , // {bson#Binary} the chunk data itself
                         *        }
                         *        &lt;/code&gt;&lt;/pre&gt;
                         *
                         * @see &lt;a href=&quot;http://www.mongodb.org/display/DOCS/GridFS+Specification#GridFSSpecification-{{chunks}}&quot;&gt;MongoDB GridFS Chunk Object Structure&lt;/a&gt;
                         */
                        Chunk.prototype.buildMongoObject = function(callback) {
                          var mongoObject = {
                            &#x27;files_id&#x27;: this.file.fileId,
                            &#x27;n&#x27;: this.chunkNumber,
                            &#x27;data&#x27;: this.data};
                          // If we are saving using a specific ObjectId
                          if(this.objectId != null) mongoObject._id = this.objectId;
                        
                          callback(mongoObject);
                        };
                        
                        /**
                         * @return {number} the length of the data
                         */
                        Chunk.prototype.length = function() {
                          return this.data.length();
                        };
                        
                        /**
                         * The position of the read/write head
                         * @name position
                         * @lends Chunk#
                         * @field
                         */
                        Object.defineProperty(Chunk.prototype, &quot;position&quot;, { enumerable: true
                          , get: function () {
                              return this.internalPosition;
                            }
                          , set: function(value) {
                              this.internalPosition = value;
                            }
                        });
                        
                        /**
                         * The default chunk size
                         * @constant
                         */
                        Chunk.DEFAULT_CHUNK_SIZE = 1024 * 255;
                        
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
