<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>bin/node_modules/mongodb/lib/mongodb/collection/aggregation.js - Prometheus Framework</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="Prometheus Framework"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Represents a 
                Replicaset Configuration.html">Represents a 
                Replicaset Configuration</a></li>
                                <li><a href="../classes/Represents a BatchWriteResult.html">Represents a BatchWriteResult</a></li>
                                <li><a href="../classes/Represents a Collection.html">Represents a Collection</a></li>
                                <li><a href="../classes/Represents a Cursor..html">Represents a Cursor.</a></li>
                                <li><a href="../classes/Represents a CursorStream..html">Represents a CursorStream.</a></li>
                                <li><a href="../classes/Represents a Db.html">Represents a Db</a></li>
                                <li><a href="../classes/Represents a GridFS File Stream..html">Represents a GridFS File Stream.</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/Represents a MongoClient.html">Represents a MongoClient</a></li>
                                <li><a href="../classes/Represents a Mongos connection with failover to backup proxies.html">Represents a Mongos connection with failover to backup proxies</a></li>
                                <li><a href="../classes/Represents a OrderedBulkOperation.html">Represents a OrderedBulkOperation</a></li>
                                <li><a href="../classes/Represents a Read Preference..html">Represents a Read Preference.</a></li>
                                <li><a href="../classes/Represents a Server connection..html">Represents a Server connection.</a></li>
                                <li><a href="../classes/Represents a UnorderedBulkOperation.html">Represents a UnorderedBulkOperation</a></li>
                                <li><a href="../classes/Represents the Admin methods of MongoDB..html">Represents the Admin methods of MongoDB.</a></li>
                                <li><a href="../classes/Represents the Grid..html">Represents the Grid.</a></li>
                                <li><a href="../classes/Represents the GridStore..html">Represents the GridStore.</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/association.html">association</a></li>
                                <li><a href="../modules/database-accessor.html">database-accessor</a></li>
                                <li><a href="../modules/field-type-manager.html">field-type-manager</a></li>
                                <li><a href="../modules/resource-type-manager.html">resource-type-manager</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: bin/node_modules/mongodb/lib/mongodb/collection/aggregation.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        var shared = require(&#x27;./shared&#x27;)
                          , utils = require(&#x27;../utils&#x27;)
                          , AggregationCursor = require(&#x27;../aggregation_cursor&#x27;).AggregationCursor
                          , Code = require(&#x27;bson&#x27;).Code  
                          , DbCommand = require(&#x27;../commands/db_command&#x27;).DbCommand;
                        
                        /**
                         * Functions that are passed as scope args must
                         * be converted to Code instances.
                         * @ignore
                         */
                        function processScope (scope) {
                          if (!utils.isObject(scope)) {
                            return scope;
                          }
                        
                          var keys = Object.keys(scope);
                          var i = keys.length;
                          var key;
                          var new_scope = {};
                        
                          while (i--) {
                            key = keys[i];
                            if (&#x27;function&#x27; == typeof scope[key]) {
                              new_scope[key] = new Code(String(scope[key]));
                            } else {
                              new_scope[key] = processScope(scope[key]);
                            }
                          }
                        
                          return new_scope;
                        }
                        
                        var pipe = function() {
                          return new AggregationCursor(this, this.serverCapabilities);
                        }
                        
                        var mapReduce = function mapReduce (map, reduce, options, callback) {
                          if (&#x27;function&#x27; === typeof options) callback = options, options = {};
                          // Out must allways be defined (make sure we don&#x27;t break weirdly on pre 1.8+ servers)
                          if(null == options.out) {
                            throw new Error(&quot;the out option parameter must be defined, see mongodb docs for possible values&quot;);
                          }
                        
                          if (&#x27;function&#x27; === typeof map) {
                            map = map.toString();
                          }
                        
                          if (&#x27;function&#x27; === typeof reduce) {
                            reduce = reduce.toString();
                          }
                        
                          if (&#x27;function&#x27; === typeof options.finalize) {
                            options.finalize = options.finalize.toString();
                          }
                        
                          var mapCommandHash = {
                              mapreduce: this.collectionName
                            , map: map
                            , reduce: reduce
                          };
                        
                          // Add any other options passed in
                          for (var name in options) {
                            if (&#x27;scope&#x27; == name) {
                              mapCommandHash[name] = processScope(options[name]);
                            } else {
                              mapCommandHash[name] = options[name];
                            }
                          }
                        
                          // Set read preference if we set one
                          var readPreference = shared._getReadConcern(this, options);
                        
                          // If we have a read preference and inline is not set as output fail hard
                          if((readPreference != false &amp;&amp; readPreference != &#x27;primary&#x27;) 
                            &amp;&amp; options[&#x27;out&#x27;] &amp;&amp; (options[&#x27;out&#x27;].inline != 1 &amp;&amp; options[&#x27;out&#x27;] != &#x27;inline&#x27;)) {
                              readPreference = &#x27;primary&#x27;;    
                          }
                        
                          // self
                          var self = this;
                          var cmd = DbCommand.createDbCommand(this.db, mapCommandHash);
                        
                          this.db._executeQueryCommand(cmd, {readPreference:readPreference}, function (err, result) {
                            if(err) return callback(err);
                            if(!result || !result.documents || result.documents.length == 0)
                              return callback(Error(&quot;command failed to return results&quot;), null)
                        
                            // Check if we have an error
                            if(1 != result.documents[0].ok || result.documents[0].err || result.documents[0].errmsg) {
                              return callback(utils.toError(result.documents[0]));
                            }
                        
                            // Create statistics value
                            var stats = {};
                            if(result.documents[0].timeMillis) stats[&#x27;processtime&#x27;] = result.documents[0].timeMillis;
                            if(result.documents[0].counts) stats[&#x27;counts&#x27;] = result.documents[0].counts;
                            if(result.documents[0].timing) stats[&#x27;timing&#x27;] = result.documents[0].timing;
                        
                            // invoked with inline?
                            if(result.documents[0].results) {
                              // If we wish for no verbosity
                              if(options[&#x27;verbose&#x27;] == null || !options[&#x27;verbose&#x27;]) {
                                return callback(null, result.documents[0].results);
                              }
                              return callback(null, result.documents[0].results, stats);
                            }
                        
                            // The returned collection
                            var collection = null;
                        
                            // If we have an object it&#x27;s a different db
                            if(result.documents[0].result != null &amp;&amp; typeof result.documents[0].result == &#x27;object&#x27;) {
                              var doc = result.documents[0].result;
                              collection = self.db.db(doc.db).collection(doc.collection);
                            } else {
                              // Create a collection object that wraps the result collection
                              collection = self.db.collection(result.documents[0].result)
                            }
                        
                            // If we wish for no verbosity
                            if(options[&#x27;verbose&#x27;] == null || !options[&#x27;verbose&#x27;]) {
                              return callback(err, collection);
                            }
                        
                            // Return stats as third set of values
                            callback(err, collection, stats);
                          });
                        };
                        
                        /**
                         * Group function helper
                         * @ignore
                         */
                        var groupFunction = function () {
                          var c = db[ns].find(condition);
                          var map = new Map();
                          var reduce_function = reduce;
                        
                          while (c.hasNext()) {
                            var obj = c.next();
                            var key = {};
                        
                            for (var i = 0, len = keys.length; i &lt; len; ++i) {
                              var k = keys[i];
                              key[k] = obj[k];
                            }
                        
                            var aggObj = map.get(key);
                        
                            if (aggObj == null) {
                              var newObj = Object.extend({}, key);
                              aggObj = Object.extend(newObj, initial);
                              map.put(key, aggObj);
                            }
                        
                            reduce_function(obj, aggObj);
                          }
                        
                          return { &quot;result&quot;: map.values() };
                        }.toString();
                        
                        var group = function group(keys, condition, initial, reduce, finalize, command, options, callback) {
                          var args = Array.prototype.slice.call(arguments, 3);
                          callback = args.pop();
                          // Fetch all commands
                          reduce = args.length ? args.shift() : null;
                          finalize = args.length ? args.shift() : null;
                          command = args.length ? args.shift() : null;
                          options = args.length ? args.shift() || {} : {};
                        
                          // Make sure we are backward compatible
                          if(!(typeof finalize == &#x27;function&#x27;)) {
                            command = finalize;
                            finalize = null;
                          }
                        
                          if (!Array.isArray(keys) &amp;&amp; keys instanceof Object &amp;&amp; typeof(keys) !== &#x27;function&#x27; &amp;&amp; !(keys instanceof Code)) {
                            keys = Object.keys(keys);
                          }
                        
                          if(typeof reduce === &#x27;function&#x27;) {
                            reduce = reduce.toString();
                          }
                        
                          if(typeof finalize === &#x27;function&#x27;) {
                            finalize = finalize.toString();
                          }
                        
                          // Set up the command as default
                          command = command == null ? true : command;
                        
                          // Execute using the command
                          if(command) {
                            var reduceFunction = reduce instanceof Code
                                ? reduce
                                : new Code(reduce);
                        
                            var selector = {
                              group: {
                                  &#x27;ns&#x27;: this.collectionName
                                , &#x27;$reduce&#x27;: reduceFunction
                                , &#x27;cond&#x27;: condition
                                , &#x27;initial&#x27;: initial
                                , &#x27;out&#x27;: &quot;inline&quot;
                              }
                            };
                        
                            // if finalize is defined
                            if(finalize != null) selector.group[&#x27;finalize&#x27;] = finalize;
                            // Set up group selector
                            if (&#x27;function&#x27; === typeof keys || keys instanceof Code) {
                              selector.group.$keyf = keys instanceof Code
                                ? keys
                                : new Code(keys);
                            } else {
                              var hash = {};
                              keys.forEach(function (key) {
                                hash[key] = 1;
                              });
                              selector.group.key = hash;
                            }
                        
                            // Set read preference if we set one
                            var readPreference = shared._getReadConcern(this, options);
                            // Execute command
                            this.db.command(selector, {readPreference: readPreference}, function(err, result) {
                              if(err) return callback(err, null);
                              callback(null, result.retval);
                            });
                          } else {
                            // Create execution scope
                            var scope = reduce != null &amp;&amp; reduce instanceof Code
                              ? reduce.scope
                              : {};
                        
                            scope.ns = this.collectionName;
                            scope.keys = keys;
                            scope.condition = condition;
                            scope.initial = initial;
                        
                            // Pass in the function text to execute within mongodb.
                            var groupfn = groupFunction.replace(/ reduce;/, reduce.toString() + &#x27;;&#x27;);
                        
                            this.db.eval(new Code(groupfn, scope), function (err, results) {
                              if (err) return callback(err, null);
                              callback(null, results.result || results);
                            });
                          }
                        };
                        
                        var aggregate = function(pipeline, options, callback) {
                          var args = Array.prototype.slice.call(arguments, 0);
                          callback = args.pop();
                          var self = this;
                        
                          // If we have any of the supported options in the options object
                          var opts = args[args.length - 1];
                          options = opts.readPreference 
                            || opts.explain 
                            || opts.cursor 
                            || opts.out
                            || opts.allowDiskUse ? args.pop() : {}
                          // If the callback is the option (as for cursor override it)
                          if(typeof callback == &#x27;object&#x27; &amp;&amp; callback != null) options = callback;
                        
                          // Convert operations to an array
                          if(!Array.isArray(args[0])) {
                            pipeline = [];
                            // Push all the operations to the pipeline
                            for(var i = 0; i &lt; args.length; i++) pipeline.push(args[i]);
                          }
                        
                          // Is the user requesting a cursor
                          if(options.cursor != null &amp;&amp; options.out == null) {
                            // Set the aggregation cursor options
                            var agg_cursor_options = options.cursor;
                            agg_cursor_options.pipe = pipeline;
                            agg_cursor_options.allowDiskUse = options.allowDiskUse == null ? false : options.allowDiskUse;
                            // Return the aggregation cursor
                            return new AggregationCursor(this, this.serverCapabilities, agg_cursor_options);
                          }
                        
                          // If out was specified
                          if(typeof options.out == &#x27;string&#x27;) {
                            pipeline.push({$out: options.out});
                          }
                        
                          // Build the command
                          var command = { aggregate : this.collectionName, pipeline : pipeline};
                          // If we have allowDiskUse defined
                          if(options.allowDiskUse) command.allowDiskUse = options.allowDiskUse;
                        
                          // Ensure we have the right read preference inheritance
                          options.readPreference = shared._getReadConcern(this, options);
                          // If explain has been specified add it
                          if(options.explain) command.explain = options.explain;
                          // Execute the command
                          this.db.command(command, options, function(err, result) {
                            if(err) {
                              callback(err);
                            } else if(result[&#x27;err&#x27;] || result[&#x27;errmsg&#x27;]) {
                              callback(utils.toError(result));
                            } else if(typeof result == &#x27;object&#x27; &amp;&amp; result[&#x27;serverPipeline&#x27;]) {
                              callback(null, result[&#x27;serverPipeline&#x27;]);
                            } else if(typeof result == &#x27;object&#x27; &amp;&amp; result[&#x27;stages&#x27;]) {
                              callback(null, result[&#x27;stages&#x27;]);
                            } else {
                              callback(null, result.result);
                            }
                          });
                        }
                        
                        exports.mapReduce = mapReduce;
                        exports.group = group;
                        exports.aggregate = aggregate;
                        exports.pipe = pipe;
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
